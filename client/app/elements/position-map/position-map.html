<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/google-map/google-map-marker.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="position-map">
  <style>
    google-map {
        height: 100%;
        width: 100%;
    }
  </style>

  <template>
      <iron-ajax url="/api/get_positions/" handle-as="json" last-response="{{response}}"></iron-ajax>
      <!-- For development: url="/demo_positions.json" -->
      <!-- For production: url="/api/get_positions/" -->

      <google-map id="map" map="{{map}}" fit-to-markers>
          <template id="repeated" is="dom-repeat" items="[[response.points]]" as="point">
              <google-map-marker latitude="[[point.latitude]]" longitude="[[point.longitude]]" on-attach="resize"></google-map-marker>
          </template>
      </google-map>
  </template>

</dom-module>

<script>
  Polymer({
    is: 'position-map',

    properties: {
        startDate: {
            observer: '_dateChanged'
        },
        endDate: {
            observer: '_dateChanged'
        }
    },

    observers: [
        '_bothChanged(startDate, endDate)'
    ],

    attached: function() {
        console.log('attached');
        this.redraw();
    },

    _dateChanged: function () {
        // This fires twice as the dom is being rendered.
        console.log('date changed ' + this.startDate + ' end ' + this.endDate);
    },

    _bothChanged: function(startDate, endDate) {
        // This fires once when the dom is being rendered.
        console.log('both changed ' + startDate + ' end ' + endDate);
    },

    redraw: function() {
        console.log('redrawing');
        var ajax = document.querySelector('iron-ajax');
        ajax.params = {'start': this.startDate, 'end': this.endDate};
        ajax.generateRequest();
    }
  });
</script>
